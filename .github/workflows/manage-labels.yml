name: "Synchronisation des Labels sur Tous les Repos"

on:
  schedule:
    - cron: "0 0 * * 1"  # Ex√©cute chaque lundi √† minuit
  workflow_dispatch:

jobs:
  sync-labels:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v2

      - name: üìÇ V√©rifier la pr√©sence du fichier labels.json
        run: |
          if [ ! -f .github/config/labels.json ]; then
            echo "‚ùå labels.json n'existe pas !"
            exit 1
          else
            echo "‚úÖ labels.json trouv√© !"
          fi

      - name: üîç V√©rifier si le token acc√®de aux repositories
        env:
          GH_TOKEN: ${{ secrets.LABELGITHUB_TOKEN }}
        run: |
          echo "üîç R√©cup√©ration de la liste des repositories..."
          gh api user/repos --paginate --jq '.[].full_name' > repos_list.txt

          if [ ! -s repos_list.txt ]; then
            echo "‚ùå Aucun repository trouv√© !"
            exit 1
          fi

          cat repos_list.txt

      - name: Lister tous les repos et appliquer les labels
        env:
          GH_TOKEN: ${{ secrets.LABELGITHUB_TOKEN }}
        run: |
          echo "üîç D√©but du traitement des repositories..."

          while read -r repo; do
            # Ignorer le repo priv√© `.gitworkflow`
            if [[ "$repo" == "djoudj-dev/.gitworkflow" ]]; then
              echo "‚ö†Ô∏è Ignor√© : $repo (repository priv√©)"
              continue
            fi

            echo "üìå V√©rification du repository $repo"

            # V√©rifier si le repo est accessible avant d'envoyer la requ√™te
            if gh api repos/$repo --silent; then
              echo "‚úÖ Suppression des anciens labels pour $repo"

              # R√©cup√©rer et supprimer tous les labels existants
              gh api repos/$repo/labels --jq '.[].name' | tr -d '"' | while read -r label; do
                echo "üóëÔ∏è Suppression du label : $label"
                gh api -X DELETE repos/$repo/labels/"$label" || echo "‚ö†Ô∏è Impossible de supprimer $label"
                sleep 1  # Pause pour √©viter de d√©passer la limite API GitHub
              done

              echo "‚úÖ Ajout des nouveaux labels pour $repo"

              # Lire et ajouter les labels un par un depuis le fichier JSON
              jq -c '.[]' .github/config/labels.json | while read -r label; do
                NAME=$(echo "$label" | jq -r '.name')
                DESCRIPTION=$(echo "$label" | jq -r '.description')
                COLOR=$(echo "$label" | jq -r '.color')

                echo "üìå Ajout du label : $NAME"

                gh api -X POST repos/$repo/labels \
                  -H "Accept: application/vnd.github.v3+json" \
                  -f name="$NAME" \
                  -f description="$DESCRIPTION" \
                  -f color="$COLOR" || echo "‚ö†Ô∏è Impossible d'ajouter $NAME"

                sleep 1  # Pause pour √©viter de d√©passer la limite API GitHub
              done
            else
              echo "‚ö†Ô∏è Le repo $repo est inaccessible. Il sera ignor√©."
            fi
          done < repos_list.txt

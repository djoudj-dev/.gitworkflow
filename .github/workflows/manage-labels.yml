name: "Synchronisation des Labels sur Tous les Repos"

on:
  schedule:
    - cron: "0 0 * * 1"  # Ex√©cute chaque lundi √† minuit
  workflow_dispatch:

jobs:
  sync-labels:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v2

      - name: üìÇ V√©rifier la pr√©sence du fichier labels.yml
        run: |
          if [ ! -f .github/config/labels.yml ]; then
            echo "‚ùå labels.yml n'existe pas !"
            exit 1
          else
            echo "‚úÖ labels.yml trouv√© !"
          fi

      - name: üîç V√©rifier si le token acc√®de aux repositories
        env:
          GH_TOKEN: ${{ secrets.LABELGITHUB_TOKEN }}
        run: |
          echo "üîç R√©cup√©ration de la liste des repositories..."
          gh api user/repos --paginate --jq '.[].full_name' > repos_list.txt
          cat repos_list.txt || echo "‚ùå Erreur : Impossible de r√©cup√©rer les repositories"

      - name: Lister tous les repos et appliquer les labels
        env:
          GH_TOKEN: ${{ secrets.LABELGITHUB_TOKEN }}
        run: |
          echo "üîç D√©but du traitement des repositories..."

          # Lire les repositories r√©cup√©r√©s
          while read -r repo; do
            # Ignorer le repo priv√© `.gitworkflow`
            if [[ "$repo" == "djoudj-dev/.gitworkflow" ]]; then
              echo "‚ö†Ô∏è Ignor√© : $repo (repository priv√©)"
              continue
            fi

            echo "üìå V√©rification du repository $repo"

            # V√©rifier si le repo est accessible avant d'envoyer la requ√™te
            if gh api repos/$repo --silent; then
              echo "‚úÖ Mise √† jour des labels pour $repo"
              gh api -X POST repos/$repo/labels \
                -H "Accept: application/vnd.github.v3+json" \
                --input .github/config/labels.yml
            else
              echo "‚ö†Ô∏è Le repo $repo est inaccessible. Il sera ignor√©."
            fi
          done < repos_list.txt
